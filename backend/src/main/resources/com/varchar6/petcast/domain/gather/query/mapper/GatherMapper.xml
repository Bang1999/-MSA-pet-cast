<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.varchar6.petcast.domain.gather.query.mapper.GatherMapper">
    <resultMap id="gatherResultMap" type="com.varchar6.petcast.domain.gather.query.dto.GatherDTO">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="content" column="content"/>
        <result property="count" column="count"/>
        <result property="url" column="url"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="activeYn" column="active_yn"/>
        <result property="invitationId" column="invitation_id"/>
        <result property="invitationContent" column="invitation_content"/>
    </resultMap>

    <select id="selectGatherById" resultMap="gatherResultMap" parameterType="_int">
        SELECT
               A.name
          FROM tbl_gather A
         WHERE A.id = (SELECT B.gather_group_member_id
                         FROM tbl_group_member B
                        WHERE B.member_group_member_id = (SELECT C.id
                                                            FROM tbl_member C
                                                           WHERE C.id = #{ user_id }))
         ORDER BY A.created_at DESC
    </select>

    <select id="selectGatherDetailById" resultMap="gatherResultMap" parameterType="_int">
        SELECT
               A.name
             , A.content
             , A.count
             , A.url
             , A.updated_at
             , A.created_at
             , A.active_yn
          FROM tbl_gather A
         WHERE A.id = #{ gather_id }
    </select>

    <select id="selectMembersById" resultType="String" parameterType="_int">
        SELECT
               A.name
          FROM tbl_member A
         WHERE A.id IN (SELECT B.member_group_member_id
                          FROM tbl_group_member B
                         WHERE B.gather_group_member_id = #{ gather_id })
    </select>

    <select id="selectGroupMembersIdById" resultType="_int" parameterType="map">
        SELECT
               A.member_group_member_id
          FROM tbl_group_member A
         WHERE A.gather_group_member_id = (SELECT
                                                  B.gather_invitation_id
                                             FROM tbl_invitation B
                                            WHERE B.member_invitation_id = #{ user_id }
                                              AND B.id = #{ invitation_id }
                                              AND B.active_yn = 1)
    </select>

    <select id="selectGroupMembersNameById" resultType="String" parameterType="_int">
        SELECT
               A.name
          FROM tbl_member A
         WHERE A.id IN (SELECT
                               B.member_group_member_id
                          FROM tbl_group_member B
                         WHERE B.gather_group_member_id = #{ gather_id })
    </select>
</mapper>